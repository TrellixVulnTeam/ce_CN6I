#!/bin/bash

# possible values: [DEVELOP | MASTER | RELEASE]
# DEVELOP: 	creates sample app, links the www folder and builds it on both platforms
# MASTER: 	creates sample app, copies the www folder and builds it on both platforms
# RELEASE: 	creates sample app, copies the www folder,builds it on both platforms, clears build folders and uploads plugin and test app to github

ENVIRONMENT=$1 
PROJECT_NAME="GetSocialSDKTestApp"
CURRENT_FOLDER="$(pwd)"
PLUGIN_FOLDER="${CURRENT_FOLDER}/plugin"
TARGET_FOLDER="${CURRENT_FOLDER}/example"
RELEASE_FOLDER="${CURRENT_FOLDER}/RELEASE"
PROJECT_RES_FOLDER="${CURRENT_FOLDER}/scripts/testApp"
TARGET_ANDROID_BUILD_FOLDER="${CURRENT_FOLDER}/example/${PROJECT_NAME}/platforms/android/build"

# 0. remove old project
echo "------------------------"
echo "Deleting previous app..."
echo "------------------------"
rm -d -R -f "${TARGET_FOLDER}"
mkdir "${CURRENT_FOLDER}/example"

# 1. create project
echo "-------------------"
echo "Creating new app..."
echo "-------------------"
cd "${TARGET_FOLDER}"
if [ "$ENVIRONMENT" == "DEVELOP" ]; then
cordova create "${PROJECT_NAME}" im.getsocial.sdk.cordova.testApp "${PROJECT_NAME}" --link-to="${PROJECT_RES_FOLDER}/www_${ENVIRONMENT}"
else
cordova create "${PROJECT_NAME}" im.getsocial.sdk.cordova.testApp "${PROJECT_NAME}"
cp -R "${PROJECT_RES_FOLDER}/www/" "${TARGET_FOLDER}/${PROJECT_NAME}/www/"
fi


# 2. cd project folder
cd ${PROJECT_NAME}/

# 3. add platforms - [iOS, Android]
echo "-------------------"
echo "Adding platforms..."
echo "-------------------"
cordova platform add ios
cordova platform add android

# 4. add GetSocialPlugin
echo "----------------------------"
echo "Adding GetSocialSDKPlugin..."
echo "----------------------------"
cordova plugin add "${PLUGIN_FOLDER}/im.getsocial.sdk.cordova"  --variable GOOGLE_APP_ID=792423680101

echo "----------------------------"
echo "Adding other cordova plugins..."
echo "----------------------------"
cordova plugin add "${PROJECT_RES_FOLDER}/dependency/cordova-plugin-facebook4" --variable APP_ID="1470803889832802" --variable APP_NAME="GetSocial Cordova Demo"
cordova plugin add "${PROJECT_RES_FOLDER}/dependency/cordova-plugin-googleplus" --variable REVERSED_CLIENT_ID=myreversedclientid

# 5. added Sign options for Android
echo "------------------"
echo "Added sign options for Android..."
echo "------------------"
cp "${PROJECT_RES_FOLDER}/sign/build-extras.gradle" "$TARGET_FOLDER/${PROJECT_NAME}/platforms/android/build-extras.gradle"
cp "${PROJECT_RES_FOLDER}/sign/google-services.json" "$TARGET_FOLDER/${PROJECT_NAME}/platforms/android/google-services.json"
mkdir "$TARGET_FOLDER/${PROJECT_NAME}/platforms/android/keystores"
cp "${PROJECT_RES_FOLDER}/sign/keystores/debug.keystore" "$TARGET_FOLDER/${PROJECT_NAME}/platforms/android/keystores/debug.keystore"

# 5. prepare project
echo "------------------"
echo "Prepare project..."
echo "------------------"
cordova prepare

# 6. replace icons

#iOS
echo "------------------"
echo "Replace icons..."
echo "------------------"

cp -R "${PROJECT_RES_FOLDER}/icons/ios/" "$TARGET_FOLDER/${PROJECT_NAME}/platforms/ios/${PROJECT_NAME}/Resources/icons/"
cp -R "${PROJECT_RES_FOLDER}/icons/android/" "$TARGET_FOLDER/${PROJECT_NAME}/platforms/android/res/"

# 7. build ios
echo "------------------"
echo "Build iOS Project..."
echo "------------------"
cordova build ios

# 8. build android
echo "------------------"
echo "Build Android Project..."
echo "------------------"
cordova build android

if [ "$ENVIRONMENT" == "RELEASE" ]; then
#delete build folders
rm -d -R -f "${TARGET_ANDROID_BUILD_FOLDER}"
fi

# 9. project is ready
echo "---------"
echo "Finished."
echo "---------"

if [ "$ENVIRONMENT" == "RELEASE" ]; then

# 10. prepare release
echo "---------"
echo "Prepare release"
echo "---------"

mkdir "${RELEASE_FOLDER}"
cp -R "${PLUGIN_FOLDER}" "${RELEASE_FOLDER}"
cp -R "${TARGET_FOLDER}" "${RELEASE_FOLDER}"
cp -R "${CURRENT_FOLDER}/CHANGELOG.md" "${RELEASE_FOLDER}/"
cp -R "${CURRENT_FOLDER}/README.md" "${RELEASE_FOLDER}/"

cd "$TARGET_FOLDER/${PROJECT_NAME}"
PLUGIN_VERSION=`cordova plugins |grep 'im.' | sed 's/im.getsocial.sdk.cordova \(.*\)\ "GetSocialSdk\"/\1/'`
BUILD_COMMIT=`git rev-parse HEAD`
cd "${CURRENT_FOLDER}"
echo -e "version=${PLUGIN_VERSION}\ncommit=${BUILD_COMMIT}\n" > "${RELEASE_FOLDER}/release.properties"

fi
